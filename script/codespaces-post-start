#!/bin/sh
# Run in codespaces after starting
echo "==> Running codespaces post-start script"

# Always want to use ZSH as my default shell (e.g. for SSH)
sudo="sudo"
if [ "${USER}" = "root" ]; then
  sudo=""
fi

if ! grep -q "${USER}.*/bin/zsh" /etc/passwd; then
  $sudo chsh -s /bin/zsh "${USER}"
fi

# Install some developer tools and setup Linux how I like it
if [ "$(command -v rg)" = "" ]; then
  $sudo apt-get -q update && $sudo apt-get -q install -y ripgrep most gh
fi

if [ ! -f "${HOME}/.netrc" ] || grep -vq "goproxy.githubapp.com" "${HOME}/.netrc"; then
  echo "machine goproxy.githubapp.com login nobody password $GITHUB_TOKEN" >> "$HOME/.netrc"
fi

if [ ! -f "${HOME}/.ssh/git_signing_ed25519" ]; then
  # Takes this from my Codespaces secrets config on GitHub
  echo "$GIT_SIGNING_KEY" > "${HOME}/.ssh/git_signing_ed25519"
  chmod 600 "${HOME}/.ssh/git_signing_ed25519"
fi

# Unset these as GitHub doesn't verify commits by the default GitHub <noreply@github.com> set by default in Codespaces
unset GIT_COMMITTER_EMAIL
unset GIT_COMMITTER_NAME