#!/usr/bin/env bash
set -euo pipefail

_exists() {
  command -v "$1" > /dev/null 2>&1
}

# Install mise and run it in parallel with other package installation
install_mise() {
  # Install mise if not already installed
  if ! _exists mise; then
    curl -fsSL https://mise.run | sh
  fi

  # Install/update packages with mise
  $HOME/.local/bin/mise install
}

install_other_packages() {
  # Install packages we can't manage with mise
{{ if .linux -}}
  arch=$(uname -m)
  packages=""
  {{- if eq .install_type "min" }}

  {{- else }}
    packages+=" most gnupg2 grc"
  {{- end }}

  if [[ -n "$packages" ]]; then
    sudo apt-get -q update > /dev/null && sudo apt-get -q install -y $packages > /dev/null
  fi
{{- else if .mac }}
  {{- if ne .install_type "min" }}
    if ! _exists git; then
      xcode-select --install
    fi

    # Adjust hammerspoon config location
    /usr/bin/defaults write org.hammerspoon.Hammerspoon MJConfigFile "~/.config/hammerspoon/init.lua"

    # Build the restic-wrapper binary
    go build -o "$HOME/.local/gobin/restic-wrapper" "{{- .chezmoi.sourceDir }}/../ano/restic-wrapper/restic-wrapper.go"

    # Load/reload backup launchd job
    if launchctl list local.restic_backup > /dev/null 2>&1; then
      launchctl unload "$HOME/Library/LaunchAgents/local.restic_backup.plist"
    fi
    launchctl load "$HOME/Library/LaunchAgents/local.restic_backup.plist"
  {{- end -}}
{{- end }}
}

# Run mise installation and other package installation in parallel
install_mise &
mise_pid=$!

install_other_packages &
other_pid=$!

# Wait for both processes to complete
wait $mise_pid
wait $other_pid
